// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tool Registry
model Tool {
  id          String   @id
  category    String
  description String
  inputSchema Json     // Zod schema serialized
  outputSchema Json    // Zod schema serialized
  policy      Json?    // Policy configuration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  toolCalls ToolCall[]
}

// Audit log for tool invocations
model ToolCall {
  id          String   @id @default(uuid())
  toolId      String
  sessionId   String?
  leadId      String?
  input       Json     // Redacted per policy
  output      Json?    // Redacted per policy
  status      String   // "success" | "error" | "blocked"
  error       String?
  metadata    Json?
  createdAt   DateTime @default(now())

  tool Tool @relation(fields: [toolId], references: [id])

  @@index([toolId])
  @@index([sessionId])
  @@index([leadId])
  @@index([createdAt])
}

// Workflow runs and traces
model WorkflowRun {
  id          String   @id @default(uuid())
  workflowId  String
  sessionId   String?
  leadId      String?
  traceRef    String?  // OpenAI trace reference
  status      String   // "running" | "completed" | "failed"
  input       Json?
  output      Json?
  error       String?
  timings     Json?    // { startedAt, completedAt, duration }
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workflowId])
  @@index([sessionId])
  @@index([traceRef])
  @@index([createdAt])
}

// OpenAI documentation cache
model OpenAIDoc {
  id          String   @id @default(uuid())
  url         String
  title       String
  section     String?  // Section identifier within page
  text        String   @db.Text
  metadata    Json?    // { publishedAt, updatedAt, tags, etc. }
  fetchedAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([url, section])
  @@index([url])
  @@index([title])
}

// Sessions
model Session {
  id          String   @id @default(uuid())
  leadId      String?
  consent     Json?    // Consent flags
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([leadId])
}

// Leads
model Lead {
  id          String   @id @default(uuid())
  email       String?  @unique
  phone       String?
  name        String?
  stage       String   @default("new")
  score       Int      @default(0)
  tags        String[]
  data        Json?    // Additional lead data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([stage])
  @@index([score])
}

// Events
model Event {
  id          String   @id @default(uuid())
  sessionId   String?
  leadId      String?
  type        String
  payload     Json?
  createdAt   DateTime @default(now())

  @@index([sessionId])
  @@index([leadId])
  @@index([type])
  @@index([createdAt])
}

// Catalog (services, FAQs)
model CatalogService {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  category    String?
  price       Float?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}

model CatalogFAQ {
  id          String   @id @default(uuid())
  question    String
  answer      String   @db.Text
  category    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}

// Templates
model Template {
  id          String   @id @default(uuid())
  name        String
  type        String   // "email" | "message" | "ui"
  content     String   @db.Text
  variables   Json?    // Variable definitions
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
}

// Human Review Queue
model HumanReviewRequest {
  id          String   @id @default(uuid())
  toolId      String
  sessionId   String?
  leadId      String?
  userId      String?
  tenantId    String?
  input       Json     // Tool input (redacted per policy)
  status      String   // "pending" | "approved" | "rejected" | "expired"
  reviewedBy  String?  // User ID who reviewed
  reviewedAt  DateTime?
  reviewNotes String?  @db.Text
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([toolId])
  @@index([status])
  @@index([tenantId])
  @@index([createdAt])
}

// Tenant Configuration - ukládá konfiguraci pro každého klienta/tenanta
model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique // URL-friendly identifier
  active      Boolean  @default(true)
  metadata    Json?    // Additional tenant metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  apiKeys     TenantAPIKey[]
  sessions    Session[]
  leads       Lead[]

  @@index([slug])
  @@index([active])
}

// Tenant API Keys - šifrované API klíče pro každého tenanta
model TenantAPIKey {
  id          String   @id @default(uuid())
  tenantId    String
  provider    String   // "openai" | "anthropic" | etc.
  keyName     String   // User-friendly name (e.g., "Production", "Development")
  encryptedKey String  @db.Text // Šifrovaný API klíč
  keyHash     String   // Hash pro rychlé vyhledávání (první 8 znaků)
  active      Boolean  @default(true)
  lastUsedAt  DateTime?
  metadata    Json?    // { model: "gpt-4", temperature: 0.7, etc. }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider, keyName])
  @@index([tenantId])
  @@index([provider])
  @@index([keyHash])
  @@index([active])
}

// E-commerce: Products
model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  name        String
  description String?  @db.Text
  category    String?
  price       Float
  stock       Int      @default(0)
  metadata    Json?    // Compatibility, specifications, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@index([sku])
  @@index([category])
}

// E-commerce: Shopping Cart
model Cart {
  id          String   @id @default(uuid())
  sessionId   String?  @unique
  leadId      String?
  tenantId    String?
  items       CartItem[]
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sessionId])
  @@index([leadId])
}

// E-commerce: Cart Items
model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  price     Float    // Snapshot ceny při přidání
  metadata  Json?
  createdAt DateTime @default(now())

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
}

// E-commerce: Orders
model Order {
  id              String      @id @default(uuid())
  orderNumber     String      @unique
  leadId          String?
  tenantId        String?
  status          String      @default("pending") // pending, confirmed, paid, shipped, delivered, cancelled
  totalAmount     Float
  shippingMethod  String?
  shippingCost    Float       @default(0)
  paymentMethod   String?
  paymentStatus   String      @default("pending") // pending, paid, failed, refunded
  shippingAddress Json?
  billingAddress  Json?
  metadata        Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  items           OrderItem[]

  @@index([leadId])
  @@index([orderNumber])
  @@index([status])
}

// E-commerce: Order Items
model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Float    // Snapshot ceny při objednání
  metadata  Json?
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

// E-commerce: Quote Requests
model QuoteRequest {
  id          String   @id @default(uuid())
  leadId      String?
  sessionId   String?
  status      String   @default("draft") // draft, submitted, quoted, accepted, rejected
  data        Json     // Strukturovaná data poptávky
  attachments Json?    // Reference na fotky/dokumenty
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([leadId])
  @@index([status])
}

// E-commerce: Quotes
model Quote {
  id            String   @id @default(uuid())
  quoteRequestId String  @unique
  leadId        String?
  status        String   @default("draft") // draft, sent, accepted, rejected
  totalAmount   Float?
  items         Json     // Položky nabídky
  validUntil    DateTime?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([leadId])
  @@index([status])
}

// E-commerce: Service Tickets
model ServiceTicket {
  id          String   @id @default(uuid())
  leadId      String?
  sessionId   String?
  status      String   @default("open") // open, in_progress, waiting_parts, resolved, closed
  urgency     String   @default("normal") // low, normal, high, critical
  description String   @db.Text
  requiredParts Json?  // Detekované potřebné díly
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([leadId])
  @@index([status])
  @@index([urgency])
}

// Cost Control: Token Budget Tracking
model TokenBudget {
  id          String   @id @default(uuid())
  sessionId   String?
  workflowId  String?
  toolId      String?
  tenantId    String?
  role        String?  // LLM role (intent_detection, routing, etc.)
  budgetLimit Int      // Max tokens
  tokensUsed  Int      @default(0)
  period      String   // "session" | "workflow" | "tool" | "daily"
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sessionId])
  @@index([workflowId])
  @@index([toolId])
  @@index([tenantId])
  @@index([role])
}

// Cost Control: Cost Tracking
model CostRecord {
  id          String   @id @default(uuid())
  sessionId   String?
  workflowId  String?
  toolId      String?
  role        String?  // LLM role
  tenantId    String?
  model       String   // e.g., "gpt-4-turbo-preview"
  inputTokens Int
  outputTokens Int
  totalTokens Int
  costUSD     Float
  metadata    Json?    // Request details, fallback info, etc.
  createdAt   DateTime @default(now())

  @@index([sessionId])
  @@index([workflowId])
  @@index([toolId])
  @@index([role])
  @@index([tenantId])
  @@index([createdAt])
}

// Cost Control: Context Cache
model ContextCache {
  id          String   @id @default(uuid())
  cacheKey    String   @unique
  role        String?  // LLM role
  model       String?  // Model used
  inputHash   String   // Hash of input + context
  response    Json     @db.Text
  hitCount    Int      @default(0)
  expiresAt   DateTime
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([cacheKey])
  @@index([role])
  @@index([expiresAt])
}
